@{
    ViewData["Title"] = "Create Invoice";
}

<div class="container mt-4">
    <h2>Create Invoice</h2>
    <hr />

    <form id="invoiceForm">
        <div class="row mb-3">
            <div class="col-md-3">
                <label>Invoice No</label>
                <input type="text" id="InvoiceNo" class="form-control" required />
            </div>
            <div class="col-md-3">
                <label>Invoice Date</label>
                <input type="date" id="InvoiceDate" class="form-control" required />
            </div>
            <div class="col-md-3">
                <label>Store</label>
                <select id="StoreId" class="form-control" required>
                    <option value="">-- Choose --</option>
                </select>
            </div>
        </div>

        <!-- Items Table -->
        <table class="table table-bordered" id="itemsTable">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Unit</th>
                    <th>Price</th>
                    <th>Qty</th>
                    <th>Total</th>
                    <th>Discount</th>
                    <th>Net</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <select class="form-control item" required>
                            <option value="">-- Choose --</option>
                        </select>
                    </td>
                    <td>
                        <select class="form-control unit" required></select>
                    </td>
                    <td><input type="number" class="form-control price" min="0.01" step="0.01" required /></td>
                    <td><input type="number" class="form-control qty" min="1" step="1" required /></td>
                    <td><input type="text" class="form-control total" readonly /></td>
                    <td><input type="number" class="form-control discount" value="0" min="0" step="0.01" /></td>
                    <td><input type="text" class="form-control net" readonly /></td>
                    <td>
                        <button type="button" class="btn btn-success btn-sm addRow">+</button>
                        <button type="button" class="btn btn-danger btn-sm removeRow d-none">X</button>
                    </td>
                </tr>
            </tbody>
        </table>

        <!-- Row Message -->
        <div id="rowMessage" class="alert alert-warning d-none p-2"></div>

        <!-- Footer Totals -->
        <div class="row mt-4">
            <div class="col-md-3">
                <label>Total</label>
                <input type="text" id="Total" class="form-control" readonly />
            </div>
            <div class="col-md-3">
                <label>Taxes</label>
                <input type="number" id="Taxes" class="form-control" min="0" step="0.01" value="0" />
            </div>
            <div class="col-md-3">
                <label>Net</label>
                <input type="text" id="Net" class="form-control" readonly />
            </div>
        </div>

        <!-- Buttons -->
        <div class="mt-3">
            <button type="submit" id="saveInvoice" class="btn btn-primary">Save</button>
            <button type="button" id="deleteInvoice" class="btn btn-danger">Delete</button>
        </div>
    </form>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // ==== Load Stores ====

        function loadStores() {
            $.get("/api/lookups/stores", function (data) {
                $("#StoreId").empty().append(`<option value="">-- Choose --</option>`);
                data.forEach(s => $("#StoreId").append(`<option value="${s.id}">${s.name}</option>`));
            });
        }

        function loadItems(select) {
            $.get("/api/lookups/items", function (data) {
                select.empty().append(`<option value="">-- Choose --</option>`);
                data.forEach(i => select.append(`<option value="${i.id}" data-unitid="${i.unitId}">${i.name}</option>`));
            });
        }

        function loadUnitsByUnitId(select, unitId) {
            $.get("/api/lookups/unit/" + unitId, function (data) {
                select.empty();
                data.forEach(i => select.append(`<option value="${i.id}">${i.name}</option>`));
            });
        }

        function showRowMessage(message) {
            let $msg = $("#rowMessage");
            $msg.text(message).removeClass("d-none");
            setTimeout(() => $msg.addClass("d-none"), 2000);
        }

        function recalc() {
            let total = 0;
            $("#itemsTable tbody tr").each(function () {
                let price = parseFloat($(this).find(".price").val()) || 0;
                let qty = parseFloat($(this).find(".qty").val()) || 0;
                let discount = parseFloat($(this).find(".discount").val()) || 0;

                let rowTotal = price * qty;
                let net = rowTotal - discount;

                $(this).find(".total").val(rowTotal.toFixed(2));
                $(this).find(".net").val(net.toFixed(2));

                total += net;
            });

            $("#Total").val(total.toFixed(2));
            let taxes = parseFloat($("#Taxes").val()) || 0;
            $("#Net").val((total + taxes).toFixed(2));
        }

        // ==== Add Row ====
        $(document).on("click", ".addRow", function (e) {
            e.preventDefault();
            e.stopPropagation();

            let $lastRow = $("#itemsTable tbody tr").last();
            let item = $lastRow.find(".item").val();
            let unit = $lastRow.find(".unit").val();
            let price = parseFloat($lastRow.find(".price").val());
            let qty = parseFloat($lastRow.find(".qty").val());

            if (!item || !unit || !price || price <= 0 || !qty || qty <= 0) {
                showRowMessage("⚠️ Please fill Item, Unit, Price and Qty before adding a new row.");
                return;
            }

            let row = `<tr>
                <td><select class="form-control item" required><option value="">-- Choose --</option></select></td>
                <td><select class="form-control unit" required><option value="">-- Choose --</option></select></td>
                <td><input type="number" class="form-control price" min="0.01" step="0.01" required /></td>
                <td><input type="number" class="form-control qty" min="1" step="1" required /></td>
                <td><input type="text" class="form-control total" readonly /></td>
                <td><input type="number" class="form-control discount" value="0" min="0" step="0.01" /></td>
                <td><input type="text" class="form-control net" readonly /></td>
                <td>
                    <button type="button" class="btn btn-success btn-sm addRow">+</button>
                    <button type="button" class="btn btn-danger btn-sm removeRow">X</button>
                </td>
            </tr>`;
            $("#itemsTable tbody").append(row);
            loadItems($("#itemsTable tbody tr:last .item"));
        });

        $(document).on("click", ".removeRow", function (e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).closest("tr").remove();
            recalc();
        });

        $(document).on("change", ".item", function () {
            let unitId = $(this).find(":selected").data("unitid");
            let $unitSelect = $(this).closest("tr").find(".unit");
            if (unitId) loadUnitsByUnitId($unitSelect, unitId);
        });

        $(document).on("input", ".price, .qty, .discount, #Taxes", function () {
            if ($(this).hasClass("discount") && $(this).val().trim() === "") {
                $(this).val(0);
            }
            recalc();
        });

        $("#invoiceForm").on("submit", function (e) {
            e.preventDefault();
            if (!this.checkValidity()) {
                this.reportValidity();
                return;
            }

            let dto = {
                invoiceNo: $("#InvoiceNo").val(),
                invoiceDate: $("#InvoiceDate").val(),
                storeId: $("#StoreId").val(),
                total: parseFloat($("#Total").val()) || 0,
                taxes: parseFloat($("#Taxes").val()) || 0,
                net: parseFloat($("#Net").val()) || 0,
                items: []
            };

            $("#itemsTable tbody tr").each(function () {
                dto.items.push({
                    itemId: $(this).find(".item").val(),
                    unitId: $(this).find(".unit").val(),
                    price: parseFloat($(this).find(".price").val()) || 0,
                    qty: parseFloat($(this).find(".qty").val()) || 0,
                    total: parseFloat($(this).find(".total").val()) || 0,
                    discount: parseFloat($(this).find(".discount").val()) || 0,
                    net: parseFloat($(this).find(".net").val()) || 0
                });
            });

            $.ajax({
                url: "/Invoice/Create",
                method: "POST",
                        headers: {
            "Authorization": "Bearer " + localStorage.getItem("token")
        },

                contentType: "application/json",
                data: JSON.stringify(dto),
                success: function (res) {
                    alert("Invoice saved successfully!");
                    $("#InvoiceNo").val("");
                    $("#InvoiceDate").val("");
                    $("#StoreId").val("");
                    $("#itemsTable tbody").html(`
                        <tr>
                            <td><select class="form-control item" required><option value="">-- Choose --</option></select></td>
                            <td><select class="form-control unit" required><option value="">-- Choose --</option></select></td>
                            <td><input type="number" class="form-control price" min="0.01" step="0.01" required /></td>
                            <td><input type="number" class="form-control qty" min="1" step="1" required /></td>
                            <td><input type="text" class="form-control total" readonly /></td>
                            <td><input type="number" class="form-control discount" min="0" step="0.01" value="0" /></td>
                            <td><input type="text" class="form-control net" readonly /></td>
                            <td>
                                <button type="button" class="btn btn-success btn-sm addRow">+</button>
                                <button type="button" class="btn btn-danger btn-sm removeRow d-none">X</button>
                            </td>
                        </tr>
                    `);
                    loadItems($("#itemsTable tbody tr:first .item"));
                    $("#Total").val("");
                    $("#Taxes").val("0");
                    $("#Net").val("");
                }
            });
        });

        // ==== Delete Invoice ====
        $("#deleteInvoice").on("click", function () {
            let hasData = $("#InvoiceNo").val().trim() !== "" ||
                          $("#InvoiceDate").val().trim() !== "" ||
                          $("#StoreId").val().trim() !== "" ||
                          $("#itemsTable tbody tr").toArray().some(tr => {
                              return $(tr).find(".item").val() ||
                                     $(tr).find(".price").val() ||
                                     $(tr).find(".qty").val() ||
                                     parseFloat($(tr).find(".discount").val()) > 0;
                          }) ||
                          parseFloat($("#Taxes").val()) > 0;

            if (!hasData) {
                alert("⚠️ لا يوجد بيانات ليتم مسحها.");
                return;
            }

            if (!confirm("هل تريد مسح كل البيانات؟")) return;

            $("#InvoiceNo").val("");
            $("#InvoiceDate").val("");
            $("#StoreId").val("");
            $("#itemsTable tbody").html(`
                <tr>
                    <td><select class="form-control item" required><option value="">-- Choose --</option></select></td>
                    <td><select class="form-control unit" required><option value="">-- Choose --</option></select></td>
                    <td><input type="number" class="form-control price" min="0.01" step="0.01" required /></td>
                    <td><input type="number" class="form-control qty" min="1" step="1" required /></td>
                    <td><input type="text" class="form-control total" readonly /></td>
                    <td><input type="number" class="form-control discount" min="0" step="0.01" value="0" /></td>
                    <td><input type="text" class="form-control net" readonly /></td>
                    <td>
                        <button type="button" class="btn btn-success btn-sm addRow">+</button>
                        <button type="button" class="btn btn-danger btn-sm removeRow d-none">X</button>
                    </td>
                </tr>
            `);
            loadItems($("#itemsTable tbody tr:first .item"));
            $("#Total").val("");
            $("#Taxes").val("0");
            $("#Net").val("");
        });

        $(document).ready(function () {
            loadStores();
            loadItems($(".item").first());
        });
    </script>
}
